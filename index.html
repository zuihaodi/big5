<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>大五人格选词测评（基于 PI 词表的原型）</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: #f3f4f6;
      margin: 0;
      font-size: 14px;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px 20px 24px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
      margin-bottom: 20px;
    }
    .title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .subtitle {
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 12px;
      line-height: 1.6;
    }
    .small {
      font-size: 12px;
      color: #4b5563;
      line-height: 1.6;
    }
    .trait-page {
      display: none;
      margin-top: 8px;
    }
    .trait-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 24px;
    }
    .trait-item {
      width: 45%;
      font-size: 14px;
      line-height: 1.5;
    }
    .trait-item input {
      margin-right: 6px;
    }
    .nav-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 14px;
    }
    .btn {
      padding: 9px 18px;
      border: none;
      border-radius: 999px;
      background: #2563eb;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }
    .btn:disabled {
      background: #9ca3af;
      cursor: default;
    }
    .btn:hover:not(:disabled) {
      background: #1d4ed8;
    }
    .result-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .dim-block {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 0 10px;
    }
    .dim-block:last-child {
      border-bottom: none;
    }
    .extra-block {
      border-top: 1px solid #e5e7eb;
      margin-top: 10px;
      padding-top: 10px;
    }
    canvas {
      max-width: 320px;
      height: 220px;
      display: block;
      margin: 0 auto;
    }

    /* 手机自适应：字体稍大，选项单列 */
    @media (max-width: 640px) {
      body {
        font-size: 15px;
      }
      .container {
        padding: 16px 10px 28px;
      }
      .card {
        padding: 16px 14px 20px;
      }
      .title {
        font-size: 18px;
      }
      .subtitle {
        font-size: 13px;
      }
      .small {
        font-size: 12px;
      }
      .trait-item {
        width: 100%;
        font-size: 15px;
      }
    }
  </style>
  <!-- Chart.js 用于雷达图 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <!-- 问卷卡片（6 页向导） -->
    <div class="card">
      <div class="title">大五人格选词测评（原型，基于 PI 词表）</div>
      <div class="subtitle">
        从下面的词语中勾选「比较像我」的描述（可以多选，也可以一条都不选）。词语顺序已随机打乱，不显示属于哪个维度。<br>
        当前版本用于自我觉察和框架原型测试，不用于招聘淘汰或临床诊断。
      </div>

      <form id="traitForm" onsubmit="return false;">
        <div id="stepInfo" class="small" style="margin-bottom:6px;">
          第 1 页，共 6 页
        </div>
        <div id="traitsPages"></div>

        <div class="nav-row">
          <button type="button" id="prevBtn" class="btn" disabled>上一页</button>
          <button type="button" id="nextBtn" class="btn">下一页</button>
        </div>
      </form>
    </div>

    <!-- 结果卡片 -->
    <div id="resultContainer" class="card" style="display:none;">
      <div class="title">测评结果</div>
      <div class="subtitle">
        雷达图数值范围为 0–1，越接近 1 表示该维度偏高。上方为全局类型推断（MBTI / PI），中部为大五各维度说明与能力关键词；最底部为扩展说明（MBTI / PI / 颜色 / PDP 映射），主要供教练/内部使用。
      </div>
      <div style="margin-bottom:16px; text-align:center;">
        <canvas id="big5Chart" width="320" height="220"></canvas>
      </div>
      <div id="resultContent"></div>
    </div>
  </div>

  <script>
    // ========= 可调参数：最少 / 最多选多少个 =========
    const MIN_SELECTED = 10;   // 至少勾选 10 个词语
    const MAX_SELECTED = 40;   // 最多勾选 40 个，避免“几乎全选”

    // =========================
    // 1. 题目数据：基于 PI 词表，按语义映射到大五
    // dim: O/C/E/A/N；polarity: 1=高该维度；-1=低该维度；weight: 权重
    // =========================
    const traits = [
      // --- 支配 / 主导相关 ---
      { id: "t1",  dim: "E", polarity: 1,  weight: 1.3, label: "表达坚定、有主见（Assertive）" },
      { id: "t2",  dim: "E", polarity: 1,  weight: 1.3, label: "习惯在决策中起主导（Dominant）" },
      { id: "t3",  dim: "E", polarity: 1,  weight: 1.2, label: "风格比较强势（Forceful）" },
      { id: "t4",  dim: "N", polarity: 1,  weight: 1.2, label: "面对挑战时整体较从容（Brave）" },
      { id: "t5",  dim: "O", polarity: 1,  weight: 1.3, label: "愿意尝试新做法（Daring）" },
      { id: "t6",  dim: "C", polarity: 1,  weight: 1.1, label: "做事比较坚决（Resolute）" },
      { id: "t7",  dim: "A", polarity: -1, weight: 1.0, label: "在竞争场景中比较在意输赢（Competitive）" },
      { id: "t8",  dim: "N", polarity: 1,  weight: 1.2, label: "整体比较自信、稳定（Self-assured）" },
      { id: "t9",  dim: "A", polarity: -1, weight: 1.0, label: "对他人要求偏严格（Stern）" },
      { id: "t10", dim: "C", polarity: 1,  weight: 1.1, label: "执行标准较为严格（Strict）" },
      { id: "t11", dim: "A", polarity: -1, weight: 1.2, label: "喜欢就观点展开争论（Argumentative）" },

      // --- 外向 / 影响力 -> E ---
      { id: "t12", dim: "E", polarity: 1,  weight: 1.3, label: "喜欢社交互动（Sociable）" },
      { id: "t13", dim: "E", polarity: 1,  weight: 1.1, label: "表达有说服力（Persuasive）" },
      { id: "t14", dim: "E", polarity: 1,  weight: 1.0, label: "容易让人信服（Convincing）" },
      { id: "t15", dim: "E", polarity: 1,  weight: 1.0, label: "个人气场较强（Magnetic）" },
      { id: "t16", dim: "E", polarity: 1,  weight: 1.1, label: "在群体中影响力较大（Influential）" },
      { id: "t17", dim: "E", polarity: 1,  weight: 1.1, label: "给人感觉有魅力（Charming）" },
      { id: "t18", dim: "E", polarity: 1,  weight: 1.3, label: "话比较多、表达欲强（Talkative）" },
      { id: "t19", dim: "E", polarity: 1,  weight: 1.0, label: "精力充沛、状态积极（Spirited）" },
      { id: "t20", dim: "E", polarity: 1,  weight: 1.0, label: "容易带来氛围和趣味（Entertaining）" },
      { id: "t21", dim: "E", polarity: 1,  weight: 1.2, label: "容易和不同圈层打成一片（Good mixer）" },
      { id: "t22", dim: "E", polarity: 1,  weight: 1.3, label: "整体偏外向，喜欢热闹（Outgoing）" },

      // --- 耐心 / 稳定 -> C / N / A ---
      { id: "t23", dim: "C", polarity: 1,  weight: 1.1, label: "做事较有耐心（Patient）" },
      { id: "t24", dim: "N", polarity: 1,  weight: 1.2, label: "性格整体稳定（Stable/Steady）" },
      { id: "t25", dim: "N", polarity: 1,  weight: 1.3, label: "遇事通常能保持冷静（Calm）" },
      { id: "t26", dim: "N", polarity: 1,  weight: 1.2, label: "平时比较放松、不紧绷（Relaxed）" },
      { id: "t27", dim: "A", polarity: 1,  weight: 1.2, label: "对人温和、有亲和力（Gentle）" },
      { id: "t28", dim: "A", polarity: 1,  weight: 1.3, label: "给人感觉友好、易相处（Amiable）" },
      { id: "t29", dim: "A", polarity: 1,  weight: 1.1, label: "整体风格较随和（Easy-going）" },
      { id: "t30", dim: "E", polarity: -1, weight: 1.0, label: "不太主动发起互动（Passive）" },
      { id: "t31", dim: "N", polarity: 1,  weight: 1.1, label: "喜欢平和、安静的氛围（Peaceful）" },
      { id: "t32", dim: "C", polarity: 1,  weight: 1.1, label: "行动前会多想一想（Deliberate）" },

      // --- 严谨 / 规范 -> C / O / N ---
      { id: "t33", dim: "C", polarity: 1,  weight: 1.3, label: "做事认真负责（Conscientious）" },
      { id: "t34", dim: "C", polarity: 1,  weight: 1.2, label: "对标准要求偏高（Exacting）" },
      { id: "t35", dim: "C", polarity: 1,  weight: 1.3, label: "在意把事情做到最好（Perfectionist）" },
      { id: "t36", dim: "C", polarity: 1,  weight: 1.2, label: "比较追求准确、少出错（Accurate）" },
      { id: "t37", dim: "C", polarity: 1,  weight: 1.0, label: "做事风格偏严谨（Serious）" },
      { id: "t38", dim: "O", polarity: -1, weight: 1.1, label: "更偏好沿用传统做法（Conventional）" },
      { id: "t39", dim: "O", polarity: -1, weight: 1.0, label: "在场合中偏正式、讲规矩（Formal）" },
      { id: "t40", dim: "O", polarity: -1, weight: 1.1, label: "做决定时较为谨慎（Cautious）" },
      { id: "t41", dim: "N", polarity: -1, weight: 1.3, label: "对潜在风险比较敏感（Worrying）" },
      { id: "t42", dim: "C", polarity: 1,  weight: 1.0, label: "在细节和标准上比较讲究（Fussy）" },

      // --- 其他 -> A / N / C / O ---
      { id: "t43", dim: "A", polarity: 1,  weight: 1.3, label: "乐于为他人提供帮助（Helpful）" },
      { id: "t44", dim: "A", polarity: 1,  weight: 1.3, label: "对他人有同理心（Sympathetic）" },
      { id: "t45", dim: "A", polarity: 1,  weight: 1.2, label: "看重忠诚与承诺（Loyal）" },
      { id: "t46", dim: "A", polarity: 1,  weight: 1.0, label: "总体比较谦虚低调（Humble）" },
      { id: "t47", dim: "N", polarity: -1, weight: 1.1, label: "在陌生情境中会偏谨慎（Timid）" },
      { id: "t48", dim: "N", polarity: -1, weight: 1.3, label: "在压力情境下更容易紧张（Fearful）" },
      { id: "t49", dim: "A", polarity: -1, weight: 1.3, label: "资源分配时会优先考虑自己（Selfish）" },
      { id: "t50", dim: "A", polarity: -1, weight: 1.2, label: "对他人动机通常较为怀疑（Cynical）" },
      { id: "t51", dim: "A", polarity: -1, weight: 1.2, label: "表达观点时有时会用讽刺方式（Sarcastic）" },
      { id: "t52", dim: "A", polarity: -1, weight: 1.1, label: "在分歧中不太容易让步（Obstinate）" },
      { id: "t53", dim: "C", polarity: -1, weight: 1.2, label: "有时会按当下感觉快速行动（Impulsive）" },
      { id: "t54", dim: "C", polarity: -1, weight: 1.3, label: "执行中偶尔会忽略细节（Careless）" },
      { id: "t55", dim: "N", polarity: -1, weight: 1.2, label: "压力大时会想先躲开一下（Escapist）" },
      { id: "t56", dim: "N", polarity: -1, weight: 1.2, label: "闲下来时不太容易完全放松（Restless）" },
      { id: "t57", dim: "O", polarity: 1,  weight: 1.3, label: "思路和做法比较灵活（Flexible）" },
      { id: "t58", dim: "A", polarity: 1,  weight: 1.2, label: "对不同观点比较宽容（Tolerant）" },
      { id: "t59", dim: "A", polarity: 1,  weight: 1.3, label: "善于理解他人立场（Understanding）" },
      { id: "t60", dim: "A", polarity: 1,  weight: 1.3, label: "乐于分享与付出（Generous）" }
    ];

    const dimensionMeta = {
      O: { name: "开放性 O" },
      C: { name: "尽责性 C" },
      E: { name: "外向性 E" },
      A: { name: "宜人性 A" },
      N: { name: "情绪稳定性 N" } // N 这里定义为稳定性高/低
    };

    // =========================
    // 2. 结果解释配置（含 MBTI / PI / 颜色 / PDP 映射）
    // =========================
    const profiles = {
      O: {
        1: {
          stageLabel: "O1 稳定实践型",
          big5Summary: "更偏好熟悉、具体、可预期的做法，对新方法保持谨慎。",
          abilitySummary: ["经验复用", "标准化执行"],
          mbtiMapping: "偏 S 型（感觉型），较少表现为高 N。",
          piMapping: "近似 PI：A 较低（主导/探索驱动力较弱）。",
          color: "偏蓝/绿，但不固定。",
          pdp: "不固定对应动物。"
        },
        2: {
          stageLabel: "O2 守成好奇型",
          big5Summary: "以现有做法为基底，在安全范围内接受小改动。",
          abilitySummary: ["局部改进", "在旧框架内微调"],
          mbtiMapping: "偏 S，兼具一定 N 倾向。",
          piMapping: "近似 PI：A 中等水平。",
          color: "颜色不固定。",
          pdp: "不固定对应动物。"
        },
        3: {
          stageLabel: "O3 探索开放型",
          big5Summary: "主动接触新信息和方法，对不确定性有一定容忍度。",
          abilitySummary: ["信息搜集", "多方案设计", "试验与迭代"],
          mbtiMapping: "偏 N 型（直觉型），如 N 相关类型。",
          piMapping: "近似 PI：A 偏高（有推动新做法的意愿）。",
          color: "倾向黄色（开放、好奇）。",
          pdp: "不固定对应动物。"
        },
        4: {
          stageLabel: "O4 系统创新型",
          big5Summary: "高度开放，倾向从底层重构规则和系统。",
          abilitySummary: ["模式识别与抽象建模", "系统级创新与重构"],
          mbtiMapping: "强 N 倾向，经常出现在 Nx** 类型中。",
          piMapping: "近似 PI：A 很高（强变革驱动力）。",
          color: "典型黄色。",
          pdp: "不强制绑定某一种动物。"
        }
      },
      C: {
        1: {
          stageLabel: "C1 随性散漫型",
          big5Summary: "时间与任务组织度较低，更多依赖外部压力和当下感觉。",
          abilitySummary: ["在明确监督下完成任务"],
          mbtiMapping: "偏 P 型（感知型），J 倾向较弱。",
          piMapping: "近似 PI：C 低、D 低。",
          color: "颜色不固定。",
          pdp: "不固定对应动物。"
        },
        2: {
          stageLabel: "C2 情绪驱动型",
          big5Summary: "有责任感，但执行节奏受情绪和紧迫感影响。",
          abilitySummary: ["任务拆解初级", "短期冲刺"],
          mbtiMapping: "略偏 P，中性到偏 P。",
          piMapping: "近似 PI：C 中等、D 中等。",
          color: "颜色不固定。",
          pdp: "不固定对应动物。"
        },
        3: {
          stageLabel: "C3 计划执行型",
          big5Summary: "倾向提前规划和列清单，能较稳定地按计划推进。",
          abilitySummary: ["目标拆解", "计划管理", "进度跟踪"],
          mbtiMapping: "略偏 J 型，中性到偏 J。",
          piMapping: "近似 PI：C 偏高、D 偏高。",
          color: "接近蓝色。",
          pdp: "可近似猫头鹰的一部分特征。"
        },
        4: {
          stageLabel: "C4 策略系统型",
          big5Summary: "高度尽责且有强结构感，擅长中长期规划与流程设计。",
          abilitySummary: ["战略规划", "流程设计与优化", "风险预案"],
          mbtiMapping: "强 J 型（判断型），常见于 **J* 类型。",
          piMapping: "近似 PI：C 高、D 高（高度耐心和规范）。",
          color: "典型蓝色（严谨、重规则）。",
          pdp: "猫头鹰型。"
        }
      },
      E: {
        1: {
          stageLabel: "E1 退场观望型",
          big5Summary: "偏好独处或小范围互动，大场合多为旁观角色。",
          abilitySummary: ["深度一对一对话", "专注倾听"],
          mbtiMapping: "偏 I 型（内向）。",
          piMapping: "近似 PI：B 低。",
          color: "可能偏蓝/绿。",
          pdp: "不固定对应动物。"
        },
        2: {
          stageLabel: "E2 选择性社交型",
          big5Summary: "在自己看重的关系和场合中较外向，其他情境偏克制。",
          abilitySummary: ["关系筛选", "信任构建"],
          mbtiMapping: "略偏 I，中性到偏 I。",
          piMapping: "近似 PI：B 中等。",
          color: "颜色不固定。",
          pdp: "不固定对应动物。"
        },
        3: {
          stageLabel: "E3 协作外向型",
          big5Summary: "偏好群体互动与合作，乐于参与讨论和带动氛围。",
          abilitySummary: ["群体沟通", "协作带动"],
          mbtiMapping: "略偏 E，中性到偏 E。",
          piMapping: "近似 PI：B 偏高。",
          color: "偏黄/红。",
          pdp: "不固定对应动物。"
        },
        4: {
          stageLabel: "E4 领导外向型",
          big5Summary: "强外向与影响驱动力，喜欢站在场合中心并主动带节奏。",
          abilitySummary: ["大场合表达与控场", "网络搭建与资源整合"],
          mbtiMapping: "强 E 型，典型 Ex** 类型。",
          piMapping: "近似 PI：B 高（强社交驱动力）。",
          color: "红色型（果断、表现欲强）。",
          pdp: "孔雀型。"
        }
      },
      A: {
        1: {
          stageLabel: "A1 对抗直率型",
          big5Summary: "重结果、重对错，表达直接，更强调立场清晰。",
          abilitySummary: ["直接表达", "立场界定"],
          mbtiMapping: "偏 T 型（思考型），F 倾向较弱。",
          piMapping: "近似 PI：A 高、C 低（强支配、低耐心）。",
          color: "偏红。",
          pdp: "不固定对应动物。"
        },
        2: {
          stageLabel: "A2 立场清晰型",
          big5Summary: "有立场，同时会注意方式，希望维持基本关系。",
          abilitySummary: ["基础换位", "折中方案"],
          mbtiMapping: "略偏 T，中性到偏 T。",
          piMapping: "近似 PI：A 中等、C 中等。",
          color: "颜色不固定。",
          pdp: "不固定对应动物。"
        },
        3: {
          stageLabel: "A3 合作共情型",
          big5Summary: "重视他人感受和合作氛围，愿意为关系做出调整。",
          abilitySummary: ["共情倾听", "双赢思维"],
          mbtiMapping: "略偏 F 型（情感型）。",
          piMapping: "近似 PI：A 偏低、C 偏高。",
          color: "偏绿/蓝绿。",
          pdp: "不固定对应动物。"
        },
        4: {
          stageLabel: "A4 关系整合型",
          big5Summary: "高度宜人，兼具边界感与共情，擅长多方平衡与协调。",
          abilitySummary: ["多方协调", "关系修复与规则共建"],
          mbtiMapping: "强 F 型，常见于 **F* 类型。",
          piMapping: "近似 PI：A 低、C 高（高配合、高耐心）。",
          color: "典型绿色（温和、体贴、重关系）。",
          pdp: "考拉型。"
        }
      },
      N: {
        1: {
          stageLabel: "N1 高敏感易波动型",
          big5Summary: "情绪反应较敏感，遇到压力时容易被影响。",
          abilitySummary: ["情绪识别", "触发点觉察（起步）"],
          mbtiMapping: "MBTI 体系中没有独立情绪稳定维度，此处不映射。",
          piMapping: "PI 不直接测情绪稳定性，此处不映射。",
          color: "颜色不绑定。",
          pdp: "不绑定对应动物。"
        },
        2: {
          stageLabel: "N2 高敏感有觉察型",
          big5Summary: "仍然敏感，但已开始主动寻找调节方式。",
          abilitySummary: ["简单情绪调节", "求助能力"],
          mbtiMapping: "MBTI 中无直接对应维度。",
          piMapping: "PI 同上，不映射。",
          color: "颜色不绑定。",
          pdp: "不绑定对应动物。"
        },
        3: {
          stageLabel: "N3 稳态稳定型",
          big5Summary: "多数压力情境下能保持功能，情绪波动可控。",
          abilitySummary: ["压力管理", "界限感"],
          mbtiMapping: "MBTI 中无直接对应维度。",
          piMapping: "PI 同上，不映射。",
          color: "颜色不绑定。",
          pdp: "不绑定对应动物。"
        },
        4: {
          stageLabel: "N4 高弹性成长型",
          big5Summary: "情绪稳定且自我觉察高，具备明显心理弹性与逆境成长能力。",
          abilitySummary: ["心理弹性", "意义建构与资源整合"],
          mbtiMapping: "MBTI 中无直接对应维度。",
          piMapping: "PI 同上，不映射。",
          color: "颜色不绑定单一类型。",
          pdp: "不绑定对应动物。"
        }
      }
    };

    // =========================
    // 3. 工具函数：打乱 & 分页
    // =========================
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    const PAGE_COUNT = 6; // 6 页
    let currentPage = 0;
    let totalPages = PAGE_COUNT;
    let hasSubmitted = false;

    function renderForm() {
      const pagesContainer = document.getElementById("traitsPages");
      pagesContainer.innerHTML = "";

      const items = traits.slice();
      shuffle(items);

      const perPage = Math.ceil(items.length / PAGE_COUNT); // 60/6=10

      for (let p = 0; p < PAGE_COUNT; p++) {
        const pageDiv = document.createElement("div");
        pageDiv.className = "trait-page";
        pageDiv.id = "page-" + p;

        const list = document.createElement("div");
        list.className = "trait-list";

        const start = p * perPage;
        const end = Math.min(start + perPage, items.length);
        for (let i = start; i < end; i++) {
          const tr = items[i];

          const label = document.createElement("label");
          label.className = "trait-item";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = tr.id;
          checkbox.name = tr.id;

          const text = document.createTextNode(tr.label);

          label.appendChild(checkbox);
          label.appendChild(text);
          list.appendChild(label);
        }

        pageDiv.appendChild(list);
        pagesContainer.appendChild(pageDiv);
      }

      totalPages = PAGE_COUNT;
      showPage(0);
    }

    function showPage(index) {
      currentPage = index;
      for (let p = 0; p < totalPages; p++) {
        const pageDiv = document.getElementById("page-" + p);
        if (pageDiv) {
          pageDiv.style.display = (p === currentPage) ? "block" : "none";
        }
      }
      const stepInfo = document.getElementById("stepInfo");
      stepInfo.textContent = "第 " + (currentPage + 1) + " 页，共 " + totalPages + " 页";

      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      prevBtn.disabled = hasSubmitted || currentPage === 0;
      if (hasSubmitted) {
        nextBtn.disabled = true;
        nextBtn.textContent = "已提交";
      } else {
        nextBtn.disabled = false;
        nextBtn.textContent = (currentPage === totalPages - 1) ? "提交测评" : "下一页";
      }
    }

    // =========================
    // 4. 计算得分（支持权重）
    // =========================
    function computeScores() {
      const dims = ["O", "C", "E", "A", "N"];
      const result = {};

      dims.forEach(dim => {
        const dimTraits = traits.filter(t => t.dim === dim);
        let maxAbsSum = 0;
        let raw = 0;

        dimTraits.forEach(tr => {
          maxAbsSum += tr.weight;
          const checked = document.getElementById(tr.id).checked;
          if (checked) {
            raw += tr.polarity * tr.weight;
          }
        });

        let norm = 0.5;
        if (maxAbsSum > 0) {
          norm = (raw + maxAbsSum) / (2 * maxAbsSum);
        }

        let stage = 1;
        if (norm >= 0.75) stage = 4;
        else if (norm >= 0.5) stage = 3;
        else if (norm >= 0.25) stage = 2;

        result[dim] = { raw, norm, stage };
      });

      return result;
    }

    // =========================
    // 4.5 全局 MBTI 推断 & 全局 PI 推断
    // =========================
    function inferGlobalMBTI(scores) {
      const O = scores.O.norm;
      const C = scores.C.norm;
      const E = scores.E.norm;
      const A = scores.A.norm;

      const ei = E >= 0.5 ? "E" : "I";   // 外向性高 → E，否则 I
      const sn = O >= 0.5 ? "N" : "S";   // 开放性高 → N，否则 S
      const tf = A >= 0.5 ? "F" : "T";   // 宜人性高 → F，否则 T
      const jp = C >= O ? "J" : "P";     // 尽责性相对更高 → J，否则 P

      const type = ei + sn + tf + jp;
      const explanation =
        "本类型为基于大五轮廓的近似推断：E/I 来自外向性，S/N 来自开放性，T/F 来自宜人性高低，J/P 由尽责性相对开放性的高低推断，仅供参考，不等同于正式 MBTI 测验结果。";

      return { type, explanation };
    }

    function clamp01(x) {
      return Math.max(0, Math.min(1, x));
    }

    function inferGlobalPI(scores) {
      const O = scores.O.norm;
      const C = scores.C.norm;
      const E = scores.E.norm;
      const A = scores.A.norm;

      // A（主导）：外向 + 低宜人（更敢坚持自己）
      const a_pi = clamp01(0.6 * (1 - A) + 0.4 * E);
      // B（外向）：直接用 E
      const b_pi = clamp01(E);
      // C（耐心）：近似用 C（尽责 + 节奏稳定）
      const c_pi = clamp01(C);
      // D（严谨）：高尽责 + 低开放（更偏传统和规矩）
      const d_pi = clamp01(0.5 * C + 0.5 * (1 - O));

      function levelLabel(v) {
        if (v < 0.35) return "偏低";
        if (v > 0.65) return "偏高";
        return "中等";
      }
      function levelCode(v) {
        if (v < 0.35) return "低";
        if (v > 0.65) return "高";
        return "中";
      }

      const code =
        "A" + levelCode(a_pi) +
        "-B" + levelCode(b_pi) +
        "-C" + levelCode(c_pi) +
        "-D" + levelCode(d_pi);

      const summary =
        "A（主导）" + levelLabel(a_pi) +
        "，B（外向）" + levelLabel(b_pi) +
        "，C（耐心）" + levelLabel(c_pi) +
        "，D（严谨）" + levelLabel(d_pi) +
        "（代码：" + code + "，为基于大五的近似推断，不等同于正式 PI 报告）。";

      return {
        A: a_pi,
        B: b_pi,
        C: c_pi,
        D: d_pi,
        code,
        summary
      };
    }

    // =========================
    // 5. 渲染结果 & 雷达图
    // =========================
    let big5Chart = null;

    function renderResult(scores) {
      const container = document.getElementById("resultContainer");
      const content = document.getElementById("resultContent");
      content.innerHTML = "";

      // 先显示容器，再绘制图表
      container.style.display = "block";

      // --------- 全局类型推断块（MBTI + PI） ----------
      const globalMBTI = inferGlobalMBTI(scores);
      const globalPI = inferGlobalPI(scores);

      const globalBlock = document.createElement("div");
      globalBlock.className = "dim-block";

      const globalTitle = document.createElement("div");
      globalTitle.className = "result-title";
      globalTitle.textContent = "全局类型推断（仅供参考）";
      globalBlock.appendChild(globalTitle);

      const mbtiLine = document.createElement("div");
      mbtiLine.className = "small";
      mbtiLine.textContent =
        "MBTI 近似类型：" + globalMBTI.type + "。" + globalMBTI.explanation;
      globalBlock.appendChild(mbtiLine);

      const piLine = document.createElement("div");
      piLine.className = "small";
      piLine.textContent = "PI 近似轮廓：" + globalPI.summary;
      globalBlock.appendChild(piLine);

      content.appendChild(globalBlock);

      // --------- 中部：大五维度 + 能力说明 ----------
      ["O", "C", "E", "A", "N"].forEach(dim => {
        const info = scores[dim];
        const profile = profiles[dim][info.stage];

        const wrapper = document.createElement("div");
        wrapper.className = "dim-block";

        const title = document.createElement("div");
        title.className = "result-title";
        title.textContent = dimensionMeta[dim].name + "：" + profile.stageLabel;
        wrapper.appendChild(title);

        const p1 = document.createElement("div");
        p1.className = "small";
        p1.textContent = "说明：" + profile.big5Summary;
        wrapper.appendChild(p1);

        const p2 = document.createElement("div");
        p2.className = "small";
        p2.textContent = "能力关键词：" + profile.abilitySummary.join("，");
        wrapper.appendChild(p2);

        content.appendChild(wrapper);
      });

      // --------- 底部扩展说明：MBTI / PI / 颜色 / PDP ----------
      const extra = document.createElement("div");
      extra.className = "extra-block";

      const extraTitle = document.createElement("div");
      extraTitle.className = "result-title";
      extraTitle.textContent = "维度级扩展说明（MBTI / PI / 颜色心理学 / PDP 映射）";
      extra.appendChild(extraTitle);

      ["O", "C", "E", "A", "N"].forEach(dim => {
        const info = scores[dim];
        const profile = profiles[dim][info.stage];

        const line = document.createElement("div");
        line.className = "small";
        line.textContent =
          dimensionMeta[dim].name + " - " + profile.stageLabel +
          "： MBTI：" + profile.mbtiMapping +
          "； PI：" + profile.piMapping +
          "； 颜色：" + profile.color +
          "； PDP：" + profile.pdp;
        extra.appendChild(line);
      });

      content.appendChild(extra);

      // 雷达图
      const ctx = document.getElementById("big5Chart").getContext("2d");
      const labels = ["开放性 O", "尽责性 C", "外向性 E", "宜人性 A", "情绪稳定性 N"];
      const data = ["O", "C", "E", "A", "N"].map(dim => scores[dim].norm);

      if (big5Chart) {
        big5Chart.destroy();
      }

      big5Chart = new Chart(ctx, {
        type: "radar",
        data: {
          labels: labels,
          datasets: [{
            label: "大五得分（0–1）",
            data: data,
            fill: true,
            backgroundColor: "rgba(37,99,235,0.15)",
            borderColor: "#2563eb",
            pointBackgroundColor: "#2563eb",
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              suggestedMin: 0,
              suggestedMax: 1,
              ticks: {
                stepSize: 0.25
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });

      container.scrollIntoView({ behavior: "smooth" });
    }

    // =========================
    // 6. 绑定事件（含“只允许提交一次” + 数量限制）
    // =========================
    renderForm();

    document.getElementById("prevBtn").addEventListener("click", () => {
      if (hasSubmitted) return;
      if (currentPage > 0) {
        showPage(currentPage - 1);
      }
    });

    document.getElementById("nextBtn").addEventListener("click", () => {
      if (hasSubmitted) {
        alert("本次测评结果已生成。如需重新测评，请刷新页面。");
        return;
      }

      if (currentPage < totalPages - 1) {
        showPage(currentPage + 1);
      } else {
        // 最后一页：先检查勾选数量
        const checkedCount = document.querySelectorAll(
          '#traitForm input[type="checkbox"]:checked'
        ).length;

        if (checkedCount < MIN_SELECTED) {
          alert("当前选择的词语过少（" + checkedCount +
            " 个），请至少选择 " + MIN_SELECTED +
            " 个更符合自己的描述，再提交。");
          return;
        }
        if (checkedCount > MAX_SELECTED) {
          alert("当前选择的词语过多（" + checkedCount +
            " 个），建议只勾选最符合自己的描述，不要超过 " +
            MAX_SELECTED + " 个。");
          return;
        }

        const scores = computeScores();
        renderResult(scores);
        hasSubmitted = true;
        // 提交后禁用按钮，防止重复计算和修改
        document.getElementById("prevBtn").disabled = true;
        document.getElementById("nextBtn").disabled = true;
        document.getElementById("nextBtn").textContent = "已提交";
      }
    });
  </script>
</body>
</html>
