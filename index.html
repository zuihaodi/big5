<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>人格选词测评</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --bg: #f4f5fb;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-sub: #4b5563;
      --border-soft: #e5e7eb;
      --danger: #b91c1c;
      --warning: #d97706;
      --success: #047857;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui,
        "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: radial-gradient(circle at top left, #e0f2fe, #eef2ff 35%, #f9fafb 70%);
      color: var(--text-main);
    }

    .page-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 24px 16px;
    }

    .card {
      width: 100%;
      max-width: 960px;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.12),
        0 0 0 1px rgba(148, 163, 184, 0.2);
      padding: 24px 28px 28px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .header {
      border-bottom: 1px solid var(--border-soft);
      padding-bottom: 12px;
      margin-bottom: 8px;
    }

    .title {
      margin: 0 0 6px;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.03em;
      color: #0f172a;
    }

    .subtitle {
      font-size: 14px;
      color: var(--text-sub);
      line-height: 1.6;
    }

    .subtitle strong {
      color: var(--primary);
    }

    .main-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 1.1fr);
      gap: 20px;
      align-items: flex-start;
    }

    .left-panel, .right-panel {
      background: #f9fafb;
      border-radius: 16px;
      padding: 14px 14px 16px;
      border: 1px solid #e5e7eb;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .step-indicator {
      font-size: 12px;
      color: var(--text-sub);
    }

    .traits-grid {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .trait-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      background: #ffffff;
      border: 1px solid transparent;
      transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
      cursor: pointer;
      font-size: 13px;
      line-height: 1.5;
    }

    .trait-item:hover {
      border-color: var(--primary-soft);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.25);
    }

    .trait-item input[type="checkbox"] {
      margin-top: 2px;
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .trait-label { flex: 1; cursor: pointer; }

    .trait-label-main {
      font-weight: 500;
      color: #111827;
    }

    .trait-label-sub {
      display: block;
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .nav-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      gap: 8px;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-sub);
    }

    .nav-right {
      display: flex;
      gap: 8px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease,
                  box-shadow 0.15s ease, transform 0.05s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:hover {
      background: #1d4ed8;
      box-shadow: 0 14px 28px rgba(37, 99, 235, 0.45);
      transform: translateY(-0.5px);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover { background: #d1d5db; }

    .btn-ghost {
      background: transparent;
      color: var(--text-sub);
      padding-inline: 10px;
    }

    button:disabled {
      background: #e5e7eb !important;
      color: #9ca3af !important;
      box-shadow: none !important;
      cursor: default;
      transform: none !important;
    }

    .result-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .result-block {
      background: #ffffff;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
    }

    .result-block h3 {
      margin: 0 0 6px;
      font-size: 14px;
    }

    .result-block p {
      margin: 4px 0;
      font-size: 13px;
      color: var(--text-sub);
      line-height: 1.6;
    }

    .tag-line {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .dim-list {
      margin: 4px 0 0;
      padding-left: 18px;
      font-size: 13px;
      color: var(--text-sub);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 6px;
    }

    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-danger  { background: #fee2e2; color: #991b1b; }
    .badge-success { background: #dcfce7; color: #166534; }

    .radar-wrapper {
      width: 100%;
      max-width: 320px;
      margin: 0 auto;
      padding: 6px 4px 2px;
    }

    #radarChart {
      width: 100% !important;
      height: auto !important;
    }

    .user-tag-input {
      margin-top: 6px;
      font-size: 13px;
      color: var(--text-sub);
    }

    .user-tag-input input {
      padding: 4px 6px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      min-width: 140px;
    }

    @media (max-width: 900px) {
      .card {
        padding: 18px 16px 20px;
        border-radius: 0;
        box-shadow: none;
      }
      .main-layout { grid-template-columns: 1fr; }
      .left-panel, .right-panel { padding: 10px 10px 12px; }
      .title { font-size: 20px; }
      .subtitle { font-size: 13px; }
      .trait-item {
        font-size: 14px;
        padding: 8px 10px;
      }
      .trait-label-sub { font-size: 12px; }
      .traits-grid { max-height: none; }
      button { font-size: 13px; padding: 8px 14px; }
    }

    @media (max-width: 480px) {
      .nav-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .nav-right {
        width: 100%;
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>
<div class="page-wrapper">
  <div class="card">
    <div class="header">
      <h1 class="title">人格选词测评</h1>
      <div class="subtitle">
        请从下面的词语中勾选「像我」的描述，<strong>最少选择 10 个</strong>。<br />
        词语都是中性或偏正向的表达，用来捕捉你的偏好和风格，而不是评判好坏。
      </div>
      <div class="user-tag-input">
        测评昵称 / 编号（必填）： 
        <input id="userTag" type="text" placeholder="例如：小明 / 2024-001" />
      </div>
    </div>

    <div class="main-layout">
      <!-- 左侧：选词 -->
      <div class="left-panel">
        <div class="section-title">
          <span>步骤 1：勾选符合你的词语</span>
          <span class="step-indicator" id="stepInfo"></span>
        </div>
        <div id="traitsContainer" class="traits-grid"></div>
        <div class="nav-row">
          <div class="nav-left">
            <span id="selectedCountInfo">已选 0 个</span>
          </div>
          <div class="nav-right">
            <button id="prevBtn" class="btn-secondary" type="button">上一页</button>
            <button id="nextBtn" class="btn-primary" type="button">下一页</button>
          </div>
        </div>
        <div class="nav-row" style="margin-top:6px;justify-content:flex-end;">
          <button id="recalcBtn" class="btn-ghost" type="button" style="display:none;">
            重新根据当前选项计算结果
          </button>
        </div>
      </div>

      <!-- 右侧：结果 -->
      <div class="right-panel">
        <div class="section-title">
          <span>步骤 2：查看测评结果</span>
          <span class="tag-line" id="statusHint">提交后在此查看整体画像与类型推断</span>
        </div>
        <div id="resultContent" class="result-section">
          <div class="result-block">
            <p>当前还未提交。完成选词后，点击右下角「提交测评」生成你的画像。</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // 你的 Apps Script Web 应用地址
  const GS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzno1MNC9Em9pQ9FKUawifRSvlIXdi7pWQL8Wq9icgdl7ncE-cHJXKMIMXdqFey6Q_AkQ/exec";

  // 为每个浏览器生成一个匿名 clientId
  function getClientId() {
    try {
      let cid = localStorage.getItem("personality_client_id");
      if (!cid) {
        cid =
          "u_" +
          Math.random().toString(16).slice(2) +
          Date.now().toString(16);
        localStorage.setItem("personality_client_id", cid);
      }
      return cid;
    } catch (e) {
      return (
        "u_" +
        Math.random().toString(16).slice(2) +
        Date.now().toString(16)
      );
    }
  }

  const dims = ["O", "C", "E", "A", "N"]; // 开放、尽责、社交活力、宜人、情绪敏感度

  // 85 个词汇（略，请保留原样）—— 和之前那版完全一致
  const traits = [
    { id: "t1", label: "好胜的（有竞争心，喜欢赢）",
      weights: { A: -0.6, C: 0.2, N: 0.2, O: 0, E: 0 } },
    { id: "t2", label: "坚定的（主见明确，敢于表达立场）",
      weights: { A: -0.2, N: -0.3, O: 0, C: 0, E: 0 } },
    { id: "t3", label: "直率的（说话直接，不太拐弯）",
      weights: { A: -0.5, O: 0.2, C: 0, N: 0, E: 0 } },
    { id: "t4", label: "有野心的（对目标有追求）",
      weights: { C: 0.6, A: -0.2, N: 0.1, O: 0, E: 0 } },
    { id: "t5", label: "敢言的（愿意表达真实看法）",
      weights: { A: -0.3, O: 0.3, C: 0, N: 0, E: 0 } },
    { id: "t6", label: "独立的（习惯自己做决定）",
      weights: { A: -0.3, O: 0.4, C: 0, N: 0, E: 0 } },
    { id: "t7", label: "严厉的（标准高，要求严格）",
      weights: { C: 0.5, A: -0.5, O: 0, N: 0, E: 0 } },
    { id: "t8", label: "怀疑的（习惯多问几个为什么）",
      weights: { A: -0.4, O: 0.4, C: 0.2, N: 0, E: 0 } },
    { id: "t9", label: "支配的（喜欢掌控局面）",
      weights: { A: -0.5, C: 0.2, N: 0.1, O: 0, E: 0 } },
    { id: "t10", label: "务实的（关注现实与可行性）",
      weights: { O: -0.5, C: 0.4, N: -0.1, E: 0, A: 0 } },

    { id: "t11", label: "随性的（不太按固定计划来）",
      weights: { C: -0.6, O: 0.3, N: 0.1, E: 0, A: 0 } },
    { id: "t12", label: "灵活的（容易变通和调整）",
      weights: { C: -0.4, A: 0.3, O: 0.3, E: 0, N: 0 } },
    { id: "t13", label: "即兴的（喜欢临场发挥）",
      weights: { C: -0.5, O: 0.5, E: 0, A: 0, N: 0 } },
    { id: "t14", label: "悠闲的（节奏慢，不太紧绷）",
      weights: { C: -0.7, N: -0.3, O: 0, E: 0, A: 0 } },
    { id: "t15", label: "享乐的（重视当下享受）",
      weights: { C: -0.5, O: 0.2, E: 0.2, A: 0, N: 0 } },
    { id: "t16", label: "反传统的（不太按常规来）",
      weights: { O: 0.7, C: -0.3, E: 0, A: 0, N: 0 } },
    { id: "t17", label: "梦幻的（容易沉浸在想象中）",
      weights: { O: 0.6, C: -0.4, E: 0, A: 0, N: 0 } },
    { id: "t18", label: "随和的（好说话，不太较真）",
      weights: { A: 0.5, C: -0.3, N: -0.4, O: 0, E: 0 } },
    { id: "t19", label: "多变的（容易改变兴趣或想法）",
      weights: { C: -0.4, O: 0.4, N: 0.2, E: 0, A: 0 } },
    { id: "t20", label: "大胆的（愿意尝试有风险的选择）",
      weights: { C: -0.2, O: 0.4, N: -0.1, E: 0, A: 0 } },

    { id: "t21", label: "敏感的（对细微变化很有感觉）",
      weights: { N: 0.6, O: 0.3, A: 0.2, C: 0, E: 0 } },
    { id: "t22", label: "感性的（容易被情绪和氛围打动）",
      weights: { N: 0.7, A: 0.3, O: 0, C: 0, E: 0 } },
    { id: "t23", label: "热烈的（情感外露，表达强烈）",
      weights: { N: 0.5, O: 0.3, C: 0, A: 0, E: 0.2 } },
    { id: "t24", label: "自省的（常常回顾和反思自己）",
      weights: { E: -0.5, N: 0.3, O: 0.3, C: 0, A: 0 } },
    { id: "t25", label: "警觉的（对风险和细节很敏锐）",
      weights: { N: 0.5, C: 0.3, O: 0, E: 0, A: 0 } },
    { id: "t26", label: "追求完美的（希望事情做到更好）",
      weights: { C: 0.6, N: 0.4, O: -0.2, E: 0, A: 0 } },
    { id: "t27", label: "怀旧的（容易被回忆触动）",
      weights: { N: 0.3, O: 0.2, A: 0.2, C: 0, E: 0 } },
    { id: "t28", label: "谨慎的（做决定前会多想一步）",
      weights: { C: 0.3, N: 0.4, O: -0.3, E: 0, A: 0 } },
    { id: "t29", label: "复杂的（内心活动丰富）",
      weights: { O: 0.6, N: 0.3, C: 0, E: 0, A: 0 } },
    { id: "t30", label: "谦卑的（为人低调不张扬）",
      weights: { A: 0.5, E: -0.3, N: 0.2, O: 0, C: 0 } },

    { id: "t31", label: "充满磁性的（容易吸引别人注意）",
      weights: { E: 0.7, O: 0.3, C: 0, A: 0, N: 0 } },
    { id: "t32", label: "健谈的（话比较多，容易聊起来）",
      weights: { E: 0.8, C: -0.1, O: 0, A: 0, N: 0 } },
    { id: "t33", label: "热情的（对人对事都比较热络）",
      weights: { A: 0.7, E: 0.5, O: 0, C: 0, N: 0 } },
    { id: "t34", label: "乐于助人的（愿意为别人提供帮助）",
      weights: { A: 0.8, C: 0.2, O: 0, E: 0, N: 0 } },
    { id: "t35", label: "精力充沛的（体力与精力都比较旺）",
      weights: { E: 0.4, C: 0.3, N: -0.2, O: 0, A: 0 } },
    { id: "t36", label: "有趣的（经常带来话题和笑点）",
      weights: { E: 0.6, O: 0.3, C: 0, A: 0, N: 0 } },
    { id: "t37", label: "有说服力的（讲话容易让人信服）",
      weights: { E: 0.4, C: 0.3, A: -0.1, O: 0, N: 0 } },
    { id: "t38", label: "善于交际的（容易融入人群）",
      weights: { E: 0.8, A: 0.3, C: 0, O: 0, N: 0 } },
    { id: "t39", label: "欢快的（情绪多偏积极、明朗）",
      weights: { E: 0.4, N: -0.4, A: 0.3, O: 0, C: 0 } },
    { id: "t40", label: "宽容的（对不同意见比较包容）",
      weights: { A: 0.7, O: 0.3, C: 0, E: 0, N: 0 } },

    { id: "t41", label: "传统的（更认同熟悉的做法）",
      weights: { O: -0.6, C: 0.4, A: 0.2, E: 0, N: 0 } },
    { id: "t42", label: "有条理的（做事有计划、有次序）",
      weights: { C: 0.6, O: -0.1, E: 0, A: 0, N: 0 } },
    { id: "t43", label: "一贯的（风格和习惯比较稳定）",
      weights: { C: 0.6, N: -0.3, O: 0, E: 0, A: 0 } },
    { id: "t44", label: "现实的（很看重实际效果）",
      weights: { O: -0.5, N: -0.3, C: 0.3, E: 0, A: 0 } },
    { id: "t45", label: "冷静的（遇事比较镇定）",
      weights: { N: -0.6, A: 0.3, O: 0, C: 0, E: 0 } },
    { id: "t46", label: "按部就班的（按流程一步一步来）",
      weights: { C: 0.6, O: -0.3, E: 0, A: 0, N: 0 } },
    { id: "t47", label: "有原则的（有自己的标准和底线）",
      weights: { C: 0.7, A: -0.3, O: 0, E: 0, N: 0 } },
    { id: "t48", label: "知足的（容易满足于现状）",
      weights: { N: -0.6, C: -0.2, O: 0, E: 0, A: 0 } },
    { id: "t49", label: "稳健的（做事稳重、不冒进）",
      weights: { N: -0.6, C: 0.4, O: 0, E: 0, A: 0 } },
    { id: "t50", label: "常规的（倾向按规则办事）",
      weights: { O: -0.6, A: 0.3, C: 0.3, E: 0, N: 0 } },

    { id: "t51", label: "善解人意的（容易理解他人感受）",
      weights: { A: 0.6, O: 0.3, C: 0, E: 0, N: 0 } },
    { id: "t52", label: "注重细节的（会注意到小地方）",
      weights: { C: 0.6, O: -0.3, E: 0, A: 0, N: 0 } },
    { id: "t53", label: "内敛的（不太外露情绪）",
      weights: { E: -0.6, N: -0.2, A: 0, O: 0, C: 0 } },
    { id: "t54", label: "理智的（以分析和道理为主）",
      weights: { C: 0.6, N: -0.4, A: -0.3, O: 0, E: 0 } },
    { id: "t55", label: "有艺术感的（对美和艺术很敏感）",
      weights: { O: 0.6, N: 0.4, C: 0, E: 0, A: 0 } },
    { id: "t56", label: "老练的（做事老到，有经验感）",
      weights: { O: 0.5, C: 0.5, E: 0, A: 0, N: 0 } },
    { id: "t57", label: "单纯的（想法比较简单、直接）",
      weights: { O: -0.4, A: 0.5, N: -0.3, C: 0, E: 0 } },
    { id: "t58", label: "坚韧的（遇到困难能扛得住）",
      weights: { N: -0.5, C: 0.5, O: 0, E: 0, A: 0 } },
    { id: "t59", label: "深思熟虑的（做决定前会反复权衡）",
      weights: { C: 0.6, E: -0.4, O: 0, A: 0, N: 0 } },
    { id: "t60", label: "好奇的（对新鲜事物感兴趣）",
      weights: { O: 0.6, E: 0.3, C: 0, A: 0, N: 0 } },
    { id: "t61", label: "客观的（看问题时较少带入个人好恶）",
      weights: { A: -0.4, C: 0.5, O: 0, E: 0, N: 0 } },
    { id: "t62", label: "投入的（做事时会很专注认真）",
      weights: { C: 0.5, A: 0.5, O: 0, E: 0, N: 0 } },
    { id: "t63", label: "温和的（待人不锋芒毕露）",
      weights: { A: 0.6, E: -0.3, O: 0, C: 0, N: 0 } },
    { id: "t64", label: "好学的（喜欢学习新知识）",
      weights: { O: 0.5, C: 0.5, E: 0, A: 0, N: 0 } },
    { id: "t65", label: "朴素的（生活风格简单自然）",
      weights: { O: -0.4, A: 0.4, E: -0.3, C: 0, N: 0 } },
    { id: "t66", label: "时尚的（关注形象和流行）",
      weights: { O: 0.5, E: 0.4, C: 0, A: 0, N: 0 } },
    { id: "t67", label: "公正的（在意公平和规则）",
      weights: { C: 0.5, A: 0.5, O: 0, E: 0, N: 0 } },
    { id: "t68", label: "爱幻想的（脑中常常会冒出各种点子）",
      weights: { O: 0.6, C: -0.4, E: 0, A: 0, N: 0 } },
    { id: "t69", label: "敏锐的（抓重点和关键很快）",
      weights: { C: 0.5, O: 0.5, E: 0, A: 0, N: 0 } },
    { id: "t70", label: "沉默的（不太主动说话）",
      weights: { E: -0.6, N: 0.4, A: -0.3, O: 0, C: 0 } },
    { id: "t71", label: "从容的（节奏不慌不忙）",
      weights: { N: -0.5, C: 0.4, O: 0, E: 0, A: 0 } },
    { id: "t72", label: "精明的（算得清、计划性强）",
      weights: { C: 0.6, A: -0.3, O: 0, E: 0, N: 0 } },
    { id: "t73", label: "有创造力的（会想出新点子）",
      weights: { O: 0.7, C: -0.3, E: 0, A: 0, N: 0 } },
    { id: "t74", label: "顺从的（愿意配合团体安排）",
      weights: { A: 0.6, E: -0.3, O: 0, C: 0, N: 0 } },
    { id: "t75", label: "自主的（喜欢按自己的想法来）",
      weights: { A: -0.5, E: -0.3, O: 0, C: 0, N: 0 } },
    { id: "t76", label: "系统的（习惯从整体结构去安排事情）",
      weights: { C: 0.6, O: -0.3, E: 0, A: 0, N: 0 } },
    { id: "t77", label: "哲理的（喜欢思考人生和意义）",
      weights: { O: 0.7, C: 0, E: 0, A: 0, N: 0 } },
    { id: "t78", label: "勇敢的（面对挑战不太退缩）",
      weights: { N: -0.4, C: 0.2, O: 0.2, E: 0, A: 0 } },
    { id: "t79", label: "活泼的（整个人比较有活力、爱动）",
      weights: { E: 0.6, N: -0.3, O: 0, C: 0, A: 0 } },
    { id: "t80", label: "真诚的（表达和内心基本一致）",
      weights: { A: 0.6, C: 0.4, O: 0, E: 0, N: 0 } },

    { id: "t81", label: "善于倾听的（更愿意听清楚再回应）",
      weights: { E: -0.5, A: 0.3, O: 0, C: 0, N: 0 } },
    { id: "t82", label: "注重隐私的（不太愿意公开个人细节）",
      weights: { E: -0.4, N: 0.2, A: 0, C: 0, O: 0 } },
    { id: "t83", label: "独立作业的（更喜欢自己安静完成任务）",
      weights: { E: -0.6, C: 0.3, A: 0, O: 0, N: 0 } },
    { id: "t84", label: "就事论事的（对事上较为直接，不太拐弯）",
      weights: { A: -0.3, C: 0.5, O: 0, E: 0, N: 0 } },
    { id: "t85", label: "有危机感的（会主动留意潜在风险）",
      weights: { N: 0.6, C: 0.3, O: 0, E: 0, A: 0 } }
  ];

  const MIN_SELECTED = 10;
  const TOTAL_PAGES = 6;
  const PAGE_SIZE = Math.ceil(traits.length / TOTAL_PAGES);

  const selectedMap = {};
  traits.forEach(tr => { selectedMap[tr.id] = false; });

  let currentPage = 0;
  let hasSubmitted = false;
  let radarChartInstance = null;

  const traitsContainer = document.getElementById("traitsContainer");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const stepInfo = document.getElementById("stepInfo");
  const selectedCountInfo = document.getElementById("selectedCountInfo");
  const resultContent = document.getElementById("resultContent");
  const statusHint = document.getElementById("statusHint");
  const recalcBtn = document.getElementById("recalcBtn");

  function updateSelectedCountLabel() {
    const count = Object.values(selectedMap).filter(Boolean).length;
    selectedCountInfo.textContent = `已选 ${count} 个`;
  }

  function getShortLabel(trait) {
    const text = trait.label;
    const idx = text.indexOf("（");
    return idx === -1 ? text : text.slice(0, idx);
  }

  function renderPage(pageIndex) {
    currentPage = pageIndex;
    const start = pageIndex * PAGE_SIZE;
    const end = Math.min(start + PAGE_SIZE, traits.length);

    traitsContainer.innerHTML = "";
    for (let i = start; i < end; i++) {
      const tr = traits[i];

      const item = document.createElement("label");
      item.className = "trait-item";
      item.setAttribute("for", tr.id);

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = tr.id;
      checkbox.checked = !!selectedMap[tr.id];
      checkbox.addEventListener("change", (e) => {
        selectedMap[tr.id] = e.target.checked;
        updateSelectedCountLabel();
      });

      const labelDiv = document.createElement("div");
      labelDiv.className = "trait-label";

      const full = tr.label;
      const idx = full.indexOf("（");
      let main = full, sub = "";
      if (idx !== -1) {
        main = full.slice(0, idx);
        sub = full.slice(idx);
      }

      const mainSpan = document.createElement("span");
      mainSpan.className = "trait-label-main";
      mainSpan.textContent = main;

      labelDiv.appendChild(mainSpan);

      if (sub) {
        const subSpan = document.createElement("span");
        subSpan.className = "trait-label-sub";
        subSpan.textContent = sub.replace(/^（|）$/g, "");
        labelDiv.appendChild(subSpan);
      }

      item.appendChild(checkbox);
      item.appendChild(labelDiv);
      traitsContainer.appendChild(item);
    }

    stepInfo.textContent = `第 ${currentPage + 1} / ${TOTAL_PAGES} 步`;

    prevBtn.disabled = currentPage === 0;

    if (!hasSubmitted) {
      nextBtn.disabled = false;
      nextBtn.textContent = currentPage === TOTAL_PAGES - 1 ? "提交测评" : "下一页";
    } else {
      nextBtn.disabled = false;
      nextBtn.textContent = currentPage === TOTAL_PAGES - 1 ? "最后一页" : "下一页";
    }

    updateSelectedCountLabel();
  }

  prevBtn.addEventListener("click", () => {
    if (currentPage > 0) {
      renderPage(currentPage - 1);
    }
  });

  nextBtn.addEventListener("click", () => {
    if (!hasSubmitted && currentPage === TOTAL_PAGES - 1) {
      handleSubmit(false);
      return;
    }
    if (currentPage < TOTAL_PAGES - 1) {
      renderPage(currentPage + 1);
    }
  });

  recalcBtn.addEventListener("click", () => {
    handleSubmit(true);
  });

  const contradictionPairs = [
    { a: "t1",  b: "t48" },
    { a: "t11", b: "t42" },
    { a: "t11", b: "t46" },
    { a: "t19", b: "t43" },
    { a: "t16", b: "t41" },
    { a: "t17", b: "t10" },
    { a: "t17", b: "t44" },
    { a: "t21", b: "t45" },
    { a: "t32", b: "t70" },
    { a: "t38", b: "t53" },
    { a: "t35", b: "t14" },
    { a: "t23", b: "t71" }
  ];

  function checkConsistency() {
    const selectedIds = new Set(
      traits.filter(tr => selectedMap[tr.id]).map(tr => tr.id)
    );
    const conflicts = [];
    contradictionPairs.forEach(pair => {
      if (selectedIds.has(pair.a) && selectedIds.has(pair.b)) {
        const ta = traits.find(t => t.id === pair.a);
        const tb = traits.find(t => t.id === pair.b);
        if (ta && tb) {
          conflicts.push({
            aId: pair.a,
            bId: pair.b,
            aLabel: getShortLabel(ta),
            bLabel: getShortLabel(tb)
          });
        }
      }
    });
    return { conflictCount: conflicts.length, conflicts };
  }

  const dimNames = {
    O: "开放与探索 O",
    C: "计划与执行 C",
    E: "社交活力 E",
    A: "合作与共情 A",
    N: "情绪敏感度 N"
  };

  const profiles = {
    O: {
      1: {
        stageLabel: "O1 稳定守成型",
        shortDesc: "更偏向熟悉和可控的环境，对新事物兴趣不强，但能在已有经验中反复精进。",
        abilityKeywords: ["经验记忆与复用", "流程固化", "风险规避"]
      },
      2: {
        stageLabel: "O2 审慎改进型",
        shortDesc: "在熟悉框架内愿意做一些小范围尝试，会较多权衡利弊。",
        abilityKeywords: ["问题复盘", "小步试错", "渐进式优化"]
      },
      3: {
        stageLabel: "O3 探索开放型",
        shortDesc: "乐于接触新信息和新方法，对不确定性有一定容忍度。",
        abilityKeywords: ["信息搜集", "多方案设计", "试验与迭代"]
      },
      4: {
        stageLabel: "O4 前瞻创造型",
        shortDesc: "天然喜欢探索与创造，倾向于从更长远和整体的角度思考问题。",
        abilityKeywords: ["抽象建模", "创新构想", "跨领域整合"]
      }
    },
    C: {
      1: {
        stageLabel: "C1 随性弹性型",
        shortDesc: "更随性，执行节奏受心情和情境影响大，容易临时调整计划。",
        abilityKeywords: ["灵活应变", "机会把握", "临场发挥"]
      },
      2: {
        stageLabel: "C2 情绪驱动型",
        shortDesc: "有责任感，但执行节奏受情绪和紧迫感影响较大。",
        abilityKeywords: ["短期冲刺", "任务抢救", "情境驱动执行"]
      },
      3: {
        stageLabel: "C3 计划执行型",
        shortDesc: "能制定可行计划并较好落实，任务完成率较稳定。",
        abilityKeywords: ["任务拆解", "进度跟进", "持续执行"]
      },
      4: {
        stageLabel: "C4 结构化高执行型",
        shortDesc: "高度自律，善于搭建和维护系统性、标准化的执行结构。",
        abilityKeywords: ["流程设计", "标准制定", "质量控制"]
      }
    },
    E: {
      1: {
        stageLabel: "E1 安静保留型",
        shortDesc: "在社交和互动场合更偏安静保留，喜欢独处或小范围交流。",
        abilityKeywords: ["独立思考", "深度专注", "书面表达"]
      },
      2: {
        stageLabel: "E2 选择性社交型",
        shortDesc: "在人少或熟悉的环境更愿意表达，在大场合会观望。",
        abilityKeywords: ["小组沟通", "一对一交流", "倾听与反馈"]
      },
      3: {
        stageLabel: "E3 协作外向型",
        shortDesc: "偏好群体互动与合作，在社交与表达上较为主动。",
        abilityKeywords: ["会议发言", "协作推动", "氛围带动"]
      },
      4: {
        stageLabel: "E4 高能社交型",
        shortDesc: "在多人场合比较活跃，乐于与人互动并维持较高的社交频率。",
        abilityKeywords: ["公众表达", "关系拓展", "现场掌控"]
      }
    },
    A: {
      1: {
        stageLabel: "A1 竞争自我优先型",
        shortDesc: "更在意立场和结果，不太愿意为关系做太多妥协。",
        abilityKeywords: ["立场坚守", "利益谈判", "边界感"]
      },
      2: {
        stageLabel: "A2 立场清晰型",
        shortDesc: "有立场，同时会注意方式，希望维持基本关系。",
        abilityKeywords: ["坦诚沟通", "建设性反馈", "利益平衡"]
      },
      3: {
        stageLabel: "A3 合作共赢型",
        shortDesc: "重视团队合作，愿意在合理范围内照顾多方需求。",
        abilityKeywords: ["协同合作", "冲突调停", "多方协调"]
      },
      4: {
        stageLabel: "A4 高度共情型",
        shortDesc: "对他人感受非常敏感，倾向于优先照顾关系与情绪。",
        abilityKeywords: ["情感支持", "深度共情", "关系修复"]
      }
    },
    N: {
      1: {
        stageLabel: "N1 高敏感易波动型",
        shortDesc: "对环境和人际非常敏感，情绪起伏较大，容易被外界影响带走。",
        abilityKeywords: ["情境感知", "情绪信号捕捉", "风险直觉"]
      },
      2: {
        stageLabel: "N2 高敏感有觉察型",
        shortDesc: "仍然敏感，但已经能觉察和命名自己的情绪，并开始尝试主动调节。",
        abilityKeywords: ["自我觉察", "情绪命名", "寻求支持"]
      },
      3: {
        stageLabel: "N3 稳态稳定型",
        shortDesc: "整体情绪基线较稳定，面对压力和变化时波动可控，能维持基本节奏。",
        abilityKeywords: ["压力管理", "冷静决策", "持续输出"]
      },
      4: {
        stageLabel: "N4 高弹性成长型",
        shortDesc: "既能感知情绪，又有较强的复原和弹性，能在压力后恢复并从中获得反思和成长。",
        abilityKeywords: ["情绪复原", "逆境成长", "他人情绪支持"]
      }
    }
  };

  function clamp(x, min, max) {
    return Math.max(min, Math.min(max, x));
  }

  function scoreBigFive() {
    const raw = { O: 0, C: 0, E: 0, A: 0, N: 0 };

    traits.forEach(tr => {
      if (!selectedMap[tr.id]) return;
      dims.forEach(d => {
        raw[d] += (tr.weights[d] || 0);
      });
    });

    const SCALE = {
      O: 10.0,
      C: 10.0,
      E: 12.0,
      A: 10.0,
      N: 8.0
    };

    const result = {};
    dims.forEach(d => {
      let rawVal = raw[d];
      let normSigned = rawVal / (SCALE[d] || 10.0);
      normSigned = clamp(normSigned, -1, 1);
      let norm01 = (normSigned + 1) / 2;

      let stage;
      if (d === "N") {
        if (norm01 >= 0.65)      stage = 1;
        else if (norm01 >= 0.5)  stage = 2;
        else if (norm01 >= 0.35) stage = 3;
        else                     stage = 4;
      } else {
        if (norm01 >= 0.65)      stage = 4;
        else if (norm01 >= 0.5)  stage = 3;
        else if (norm01 >= 0.35) stage = 2;
        else                     stage = 1;
      }

      result[d] = {
        norm01,
        stage,
        profile: profiles[d][stage]
      };
    });

    return result;
  }

  function renderRadar(scores) {
    const ctx = document.getElementById("radarChart");
    if (!ctx) return;
    const data = dims.map(d => Math.round(scores[d].norm01 * 100));
    if (radarChartInstance) radarChartInstance.destroy();

    radarChartInstance = new Chart(ctx, {
      type: "radar",
      data: {
        labels: ["开放与探索 O", "计划与执行 C", "社交活力 E", "合作与共情 A", "情绪敏感度 N"],
        datasets: [
          {
            label: "",
            data: [data[0], data[1], data[2], data[3], data[4]],
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          r: {
            suggestedMin: 0,
            suggestedMax: 100,
            ticks: { stepSize: 20, display: true },
            pointLabels: { font: { size: 11 } }
          }
        }
      }
    });
  }

  function inferMBTI(scores) {
    const O = scores.O.norm01;
    const C = scores.C.norm01;
    const E = scores.E.norm01;
    const A = scores.A.norm01;

    function dimLetter(val, high, low) {
      if (val >= 0.55) return high;
      if (val <= 0.45) return low;
      return high + "/" + low;
    }

    const ei = dimLetter(E, "E", "I");
    const sn = dimLetter(O, "N", "S");
    const tf = dimLetter(A, "F", "T");

    let jp;
    const highC = C >= 0.6;
    const highO = O >= 0.6;
    const lowC  = C <= 0.4;
    const lowO  = O <= 0.4;

    if (highC && !highO && !lowC) {
      jp = "J";
    } else if (lowC && highO) {
      jp = "P";
    } else if (highC && highO) {
      jp = "J";
    } else if (lowC && lowO) {
      jp = "P";
    } else {
      const idx = C - O;
      if (idx >= 0.05)      jp = "J";
      else if (idx <= -0.05) jp = "P";
      else                   jp = "J/P";
    }

    const mbti = `${ei}${sn}${tf}${jp}`;
    const note = "该类型为基于本测评五个维度的近似推断，仅供参考，不等同于正式 MBTI 测评。";
    return { mbti, note };
  }

  function inferPI(scores) {
    const O = scores.O.norm01;
    const C = scores.C.norm01;
    const E = scores.E.norm01;
    const A = scores.A.norm01;

    let A_pi = 0.7 * E + 0.5 * (1 - A);
    A_pi = clamp(A_pi / 1.2, 0, 1);

    const B_pi = clamp(E, 0, 1);
    const C_pi = clamp(0.5 * (1 - E) + 0.3 * C + 0.2 * (1 - scores.N.norm01), 0, 1);
    const D_pi = clamp(0.6 * C + 0.4 * (1 - O), 0, 1);

    function level(v) {
      if (v >= 0.7) return "高";
      if (v <= 0.3) return "低";
      return "中等";
    }

    const note = `A（支配/主导）${level(A_pi)}，B（外向/表达）${level(B_pi)}，C（耐心/节奏）${level(C_pi)}，D（严谨/规范）${level(D_pi)}。`;
    return { scores: { A: A_pi, B: B_pi, C: C_pi, D: D_pi }, note };
  }

  function inferColorAndPDP(scores, pi) {
    const O = scores.O.norm01;
    const E = scores.E.norm01;
    const A = scores.A.norm01;
    const N = scores.N.norm01;

    const yellowIdx = 0.6 * O + 0.4 * E;
    const redIdx    = pi.scores.A;
    const blueIdx   = pi.scores.D;
    const greenIdx  = 0.6 * A + 0.4 * (1 - N);

    const arr = [
      { key: "yellow", val: yellowIdx },
      { key: "red",    val: redIdx },
      { key: "blue",   val: blueIdx },
      { key: "green",  val: greenIdx }
    ].sort((a, b) => b.val - a.val);

    const top = arr[0].key;
    let colorLabel = "";
    let colorNote = "";
    let pdpAnimal = "";

    if (top === "yellow") {
      colorLabel = "黄色（乐观、创意、体验导向）";
      colorNote  = "更像是以点子和体验驱动的人，重视新鲜感和人际互动。";
      pdpAnimal  = "孔雀型";
    } else if (top === "red") {
      colorLabel = "红色（主导、推进、结果导向）";
      colorNote  = "更像是目标和结果驱动，倾向于主动掌控局面。";
      pdpAnimal  = "老虎型";
    } else if (top === "blue") {
      colorLabel = "蓝色（理性、规范、结构导向）";
      colorNote  = "更看重规则、准确和可靠性。";
      pdpAnimal  = "猫头鹰型";
    } else {
      colorLabel = "绿色（支持、配合、关系导向）";
      colorNote  = "更注重照顾他人感受与长期稳定关系。";
      pdpAnimal  = "考拉型";
    }

    return { colorLabel, colorNote, pdpAnimal };
  }

  function buildBig5Narrative(scores) {
    const order = ["O", "C", "E", "A", "N"];
    const items = order.map(d => scores[d].profile.shortDesc);
    const numbered = items.map((text, idx) => `${idx + 1}、${text}`).join("；\n");

    const abilitySet = new Set();
    order.forEach(d => {
      scores[d].profile.abilityKeywords.forEach(k => abilitySet.add(k));
    });

    const abilityText = Array.from(abilitySet).join("，");

    return `
你的整体画像大致为：
${numbered}。
您目前较突出的能力关键词包括：${abilityText}（可作为后续成长与使用优势的着力点）。`.trim();
  }

  function buildPerDimSummary(scores) {
    const lines = [];
    dims.forEach(d => {
      const s = scores[d];
      lines.push(
        `<li><strong>${dimNames[d]}：${s.profile.stageLabel}</strong> —— ${s.profile.shortDesc}</li>`
      );
    });
    return `<ul class="dim-list">${lines.join("")}</ul>`;
  }

  function buildGlobalTypeSection(scores) {
    const mbtiRes  = inferMBTI(scores);
    const piRes    = inferPI(scores);
    const colorRes = inferColorAndPDP(scores, piRes);
    const pi       = piRes.scores;

    const piText = `A=${(pi.A * 100).toFixed(0)}，B=${(pi.B * 100).toFixed(0)}，C=${(pi.C * 100).toFixed(0)}，D=${(pi.D * 100).toFixed(0)}（0–100，相对强度）`;

    return `
      <div class="result-block">
        <h3>全局类型推断（仅供参考）</h3>
        <p><strong>MBTI：</strong> 近似映射为 <strong>${mbtiRes.mbti}</strong>。${mbtiRes.note}</p>
        <p><strong>PI 行为风格：</strong> ${piText}。${piRes.note}</p>
        <p><strong>颜色心理学：</strong> 更接近 <strong>${colorRes.colorLabel}</strong>，${colorRes.colorNote}</p>
        <p><strong>PDP 动物类型：</strong> 近似为 <strong>${colorRes.pdpAnimal}</strong>（仅作为风格联想，不能代替正式测评）。</p>
      </div>
    `;
  }

  function buildConsistencyBlock(consistency) {
    const { conflictCount, conflicts } = consistency;
    if (conflictCount === 0) {
      return `
        <div class="result-block">
          <h3>选词一致性</h3>
          <p><span class="badge badge-success">较高</span> 你的选词基本没有明显相反的词组，结果可信度较高。</p>
        </div>
      `;
    }

    let levelBadge, levelText;
    if (conflictCount <= 2) {
      levelBadge = `<span class="badge badge-warning">中等</span>`;
      levelText = "存在少量方向相反的词，可能反映你在不同情境或角色下的不同表现，请结合自我感受理解结果。";
    } else {
      levelBadge = `<span class="badge badge-danger">偏低</span>`;
      levelText = "存在多组明显相反的词，本次测评结果可能不够稳定，建议你回看选项，尽量只保留「长期、典型的自己」，而不是短期状态。";
    }

    const examples = conflicts.slice(0, 4).map(p => `${p.aLabel} / ${p.bLabel}`).join("；");

    return `
      <div class="result-block">
        <h3>选词一致性</h3>
        <p>${levelBadge} 检测到 <strong>${conflictCount}</strong> 组方向相反的词语组合。</p>
        <p>示例：${examples}</p>
        <p>${levelText}</p>
      </div>
    `;
  }

  function buildResponseCountValidity(selectedCount) {
    let badge, text;
    if (selectedCount < 15) {
      badge = `<span class="badge badge-warning">提示</span>`;
      text  = "本次你勾选的词语数量较少，结果更倾向于反映你最突出的特质，对很多细节和次要偏好可能覆盖不够。";
    } else if (selectedCount > 50) {
      badge = `<span class="badge badge-warning">提示</span>`;
      text  = "本次你勾选的词语数量较多，结果可能会被平均化，建议下次只保留「最像自己的」40 个左右词语。";
    } else {
      badge = `<span class="badge badge-success">正常</span>`;
      text  = "本次你勾选的词语数量在合理范围内，结果具有一定参考价值。如需更精确，可以在下次作答时适度微调选择。";
    }
    return `
      <div class="result-block">
        <h3>作答数量与效度提示</h3>
        <p>${badge} 本次你共选择了 <strong>${selectedCount}</strong> 个词。</p>
        <p>${text}</p>
      </div>
    `;
  }

  function handleSubmit(isRecalc = false) {
  // 先检查昵称必填
  const tagInput = document.getElementById("userTag");
  const userTag = tagInput ? tagInput.value.trim() : "";
  if (!userTag) {
    alert("请先填写一个测评昵称或编号，方便后续识别自己的结果。");
    if (tagInput) tagInput.focus();
    return;
  }

    const selectedCount = Object.values(selectedMap).filter(Boolean).length;
    if (selectedCount < MIN_SELECTED) {
      alert(`请至少选择 ${MIN_SELECTED} 个「像我」的词语，目前只选了 ${selectedCount} 个。`);
      return;
    }

    const scores      = scoreBigFive();
    const consistency = checkConsistency();

    hasSubmitted = true;
    statusHint.textContent = "已生成结果，可调整勾选后再次点击「重新根据当前选项计算结果」。";
    recalcBtn.style.display = "inline-flex";

    prevBtn.disabled = currentPage === 0;
    nextBtn.disabled = false;
    nextBtn.textContent = currentPage === TOTAL_PAGES - 1 ? "最后一页" : "下一页";

    const big5Narrative   = buildBig5Narrative(scores);
    const perDimHtml      = buildPerDimSummary(scores);
    const typeHtml        = buildGlobalTypeSection(scores);
    const consistencyHtml = buildConsistencyBlock(consistency);
    const validityHtml    = buildResponseCountValidity(selectedCount);

    resultContent.innerHTML = `
      <div class="radar-wrapper result-block">
        <canvas id="radarChart"></canvas>
      </div>
      ${validityHtml}
      ${consistencyHtml}
      <div class="result-block">
        <h3>整体画像（人格 + 能力）</h3>
        <p>${big5Narrative.replace(/\n/g, "<br />")}</p>
      </div>
      <div class="result-block">
        <h3>各维度分级</h3>
        ${perDimHtml}
      </div>
      ${typeHtml}
    `;

    renderRadar(scores);

    try {
      const selectedTraits = traits
        .filter(tr => selectedMap[tr.id])
        .map(tr => tr.id);

      const mbtiRes  = inferMBTI(scores);
      const piRes    = inferPI(scores);
      const colorRes = inferColorAndPDP(scores, piRes);

      const tagInput = document.getElementById("userTag");
      const userTag  = tagInput ? tagInput.value.trim() : "";

      const payload = {
        clientId: getClientId(),
        isRecalc: !!isRecalc,
        selectedCount,
        selectedTraits,
        O: { norm01: scores.O.norm01, stage: scores.O.stage },
        C: { norm01: scores.C.norm01, stage: scores.C.stage },
        E: { norm01: scores.E.norm01, stage: scores.E.stage },
        A: { norm01: scores.A.norm01, stage: scores.A.stage },
        N: { norm01: scores.N.norm01, stage: scores.N.stage },
        mbti: mbtiRes.mbti,
        pi: piRes.scores,
        color: {
          colorLabel: colorRes.colorLabel,
          pdpAnimal: colorRes.pdpAnimal
        },
        userTag: userTag
      };

      if (GS_WEB_APP_URL && GS_WEB_APP_URL.startsWith("http")) {
        fetch(GS_WEB_APP_URL, {
          method: "POST",
          mode: "no-cors",
          headers: {
            "Content-Type": "text/plain;charset=utf-8"
          },
          body: JSON.stringify(payload)
        }).catch(err => {
          console.error("上报测评结果失败：", err);
        });
      } else {
        console.warn("GS_WEB_APP_URL 未配置，未上报到 Google 表格。");
      }
    } catch (err) {
      console.error("构造或发送上报数据出错：", err);
    }
  }

  renderPage(0);
</script>
</body>
</html>
